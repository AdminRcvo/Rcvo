name: Deploy to Elastic Beanstalk

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Elastic Beanstalk
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    # job-level env: expose secrets to the run steps
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      EB_APP_NAME: ${{ secrets.EB_APP_NAME }}
      EB_ENV_NAME: ${{ secrets.EB_ENV_NAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install jq (optional, used for debugging)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      # Detect UI folder presence and publish an output
      - id: detect_ui
        name: Detect UI presence (./ui/package.json)
        run: |
          if [ -f "./ui/package.json" ]; then
            echo "ui_present=true" >> "$GITHUB_OUTPUT"
          else
            echo "ui_present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node (if UI present)
        if: ${{ steps.detect_ui.outputs.ui_present == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build frontend (if UI present)
        if: ${{ steps.detect_ui.outputs.ui_present == 'true' }}
        run: |
          set -euo pipefail
          cd ui
          npm ci
          npm run build --if-present
          cd -

      # Create tarball in a temp dir (safe, avoids same-file mv)
      - id: make_tar
        name: Create stable snapshot tarball (safe, in temp dir)
        run: |
          set -euo pipefail

          # validate required EB secrets exist (explicit error)
          if [ -z "${EB_APP_NAME:-}" ] || [ -z "${EB_ENV_NAME:-}" ]; then
            echo "ERROR: EB_APP_NAME and EB_ENV_NAME must be set in repository Secrets."
            exit 2
          fi

          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-8)
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          ARCHIVE_NAME="rcvo-deploy-${TIMESTAMP}-${SHORT_SHA}.tar.gz"

          TMPDIR=$(mktemp -d)
          ARCHIVE_PATH="${TMPDIR}/${ARCHIVE_NAME}"

          echo "Creating archive at ${ARCHIVE_PATH} (excluded: .git, node_modules, ui/node_modules)"
          # create tar from repo root; exclude large directories
          tar --exclude='.git' --exclude='node_modules' --exclude='ui/node_modules' -czf "${ARCHIVE_PATH}" .

          echo "archive_path=${ARCHIVE_PATH}" >> "$GITHUB_OUTPUT"
          echo "archive_name=${ARCHIVE_NAME}" >> "$GITHUB_OUTPUT"

      - id: upload_s3
        name: Upload tarball to S3 (STANDARD) and confirm storage class
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          set -euo pipefail

          ARCHIVE_PATH="${{ steps.make_tar.outputs.archive_path }}"
          ARCHIVE_NAME="${{ steps.make_tar.outputs.archive_name }}"
          S3_KEY="archive/${ARCHIVE_NAME}"

          echo "Uploading ${ARCHIVE_PATH} to s3://${S3_BUCKET}/${S3_KEY} (STANDARD)"
          aws s3 cp "${ARCHIVE_PATH}" "s3://${S3_BUCKET}/${S3_KEY}" --storage-class STANDARD --only-show-errors

          # head-object returns StorageClass only for non-Standard classes in many cases.
          SC=$(aws s3api head-object --bucket "${S3_BUCKET}" --key "${S3_KEY}" --query 'StorageClass' --output text 2>/dev/null || echo "")
          # Normalize output: when it's "None" or empty, interpret as STANDARD (default).
          if [ -z "${SC}" ] || [ "${SC}" = "None" ] || [ "${SC}" = "STANDARD" ]; then
            echo "StorageClass for s3://${S3_BUCKET}/${S3_KEY} => ${SC:-STANDARD}"
          else
            echo "ERROR: uploaded object storage class is not STANDARD (found: ${SC})"
            exit 3
          fi

          echo "s3_key=${S3_KEY}" >> "$GITHUB_OUTPUT"
          echo "s3_bucket=${S3_BUCKET}" >> "$GITHUB_OUTPUT"

      - id: create_app_version
        name: Create EB application version
        env:
          EB_APP_NAME: ${{ secrets.EB_APP_NAME }}
          ARCHIVE_S3_KEY: ${{ steps.upload_s3.outputs.s3_
