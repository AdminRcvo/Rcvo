name: CI

on:
  workflow_dispatch:    # permet un lancement manuel
  pull_request:         # s‚Äôex√©cute sur toutes les PR
  push:
    branches-ignore:
      - main           # s‚Äôex√©cute sur tous les pushs sauf main

jobs:
  build-and-deploy:
    name: Build & Deploy Scaffold
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Installer & build scaffold
        working-directory: ./scaffold
        run: |
          # Si un lockfile existe, on utilise npm ci ; sinon npm install
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

          # Lance la build si le script existe, sinon on skip proprement
          npm run build || echo "‚ö†Ô∏è Pas de script 'build' : √©tape ignor√©e"

      - name: Commit des fichiers build√©s
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add scaffold/dist || echo "Rien √† ajouter"
          git commit -m "üöÄ Build scaffold [ci skip]" || echo "Pas de changements √† committer"

      - name: Push sur main
        run: |
          git push origin HEAD:main

      - name: D√©ployer vers S3
        uses: jakejarvis/s3-sync-action@v0.5.1
        with:
          args: --acl public-read --delete
        env:
          AWS_S3_BUCKET: ${{ secrets.S3_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

      - name: Invalidation CloudFront (optionnel)
        uses: chetan/invalidate-cloudfront-action@v2
        with:
          distribution-id: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}

      - name: Complete job
        run: echo "‚úÖ Build & Deploy termin√©"
